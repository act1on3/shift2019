# CSRF атака

## Описание

CSRF - это атака при которой хакер выполняет массу различных действий от имени других, зарегистрированных посетителей. Для управления сессией пользователя  многие веб-приложения используют куки (здесь и далее считаем уместным называть cookies по-русски). Браузер устроен так, что, если у него есть куки пользователя для данного домена и пути, он их автоматически отправляет вместе с HTTP-запросом.

Атаки по подделке межсайтовых запросов (CSRF) происходит в два этапа:
1) Необходимо заставить "жертву" щелкнуть по ссылке или загрузить страницу злоумышленника. Эта ссылка запускает поддельный запрос, содержащий вредоносный код. Вредоносный код обычно размещается на веб-сайте принадлежащим злоумышленнику, в другом домене.
  

2) Необходимо отправить специально созданный запрос в браузер "жертвы", который отправит законный запрос в веб-приложение (JavaScript вызывает form.submit, отправляя таким образом форму на mail.com). Запрос будет отправлен с использованием учетных данных HTTP или файлов cookie со значениями, которые хочет злоумышленник. Он будет считаться законным, даже если "жертва" будет отправлять запрос по команде злоумышленника.


## Классификация
*CSRF-атака с использованием запроса GET*

GET-запросы не должны использоваться для выполнения изменений состояния, поэтому отправка GET-запроса не изменяет никаких данных.

При щелчке вредоносной ссылки злоумышленник перенаправляет "жертву" в свое вредоносное веб-приложение, который выполняет сценарий, заставляющий браузер "жертвы" отправить незаконный (пользователь не знает о том, что он отправляется) запрос, включающий в себя необходимые файлы cookie. 


*CSRF-атаки с использованием запросов POST*

Большинство запросов на изменение состояния будут выполняться через запросы POST, отправляющие любые параметры и значения в теле запроса. 

Для запросов POST требуется, чтобы тело запроса было добавлено к самому запросу. Используя немного JavaScript, злоумышленник может заманить "жертву" в свое вредоносное веб-приложение, чтобы при загрузке веб-страницы незаконный запрос POST отправлялся автоматически.
При загрузке страницы, заготовленная функция обеспечивает отправку формы, которая в свою очередь отправляет запрос POST. В форму включены статические параметры, где, например, example.com идентифицирует запрос как законный, поскольку он будет включать файлы cookie "жертвы".


## Условия
- ОС: если проблема специфична для определенной ОС
- язык: если проблема специфичная для определенных языков
- компоненты: какие компоненты подвержены проблеме. Это могут быть библиотеки, базы данных, фреймворки, брокеры очередей и т.д.
- настройки: может есть какие-то специфичные настройки

Можно добавить еще информацию, которая не подходит под пункты выше, самостоятельно

## Детектирование
Описать как проблема детектируется. На что обращают внимание. Можно ли проблему детектировать автоматизированно или только вручную.
Если автоматизированно, то как лучше детектировать - код ревью или сканирование уязвимостей?

Информация:
- в каждый пункт можно добавлять необходимую информацию из статей в ввиде ссылок - [google.com](https://www.google.com)

## Эксплуатация

![Иллюстрация к проекту](https://github.com/kythip/shift2019/blob/master/csrf/Снимок.PNG)
![Иллюстрация к проекту](https://github.com/kythip/shift2019/blob/master/csrf/Снимок1.PNG)
![Иллюстрация к проекту](https://github.com/kythip/shift2019/blob/master/csrf/Снимок2.PNG)
---
  <!DOCTYPE html> 
  <html lang="en"> 
  <head> 
      <meta charset="UTF-8"> 
      <title>CSRF</title> 
  </head> 
  <body> 
 
  <br> 
  <p> 
      <form name="csrf_try" action="http://192.168.99.100:1337/change_settings_2" method="POST"> 
          <p><input type=hidden value="false" name=settings> 
      </form> 
  </p> 
  <script type="text/javascript"> 
  document.csrf_try.submit(); 
  </script>  
  </body> 
  </html>


## Ущерб
Описать во что возможно развитие вектора атаки, если не существует защитных мер вовсе. То есть описать, что максимльно может получить злоумышленник, если все условия сойдутся.

Написать, к чему могут привести в итоге эксплуатация этих векторов атак

## Защита
### Основные меры

1) CSRF токен 
* генерируется рандомный токен, который привязывается к сессии; 
* токен подставляется в форму и сверяется при приеме запроса; 
* атакующий не знает токена, следовательно не сможет заставить пользователя отправить запрос.

2) Double Submit Cookie 
* передавать токен клиенту двумя методами: в куках и в одном из параметров ответа (header или внутри HTML); 
* в последующих запросах предоставляются оба полученных ранее токена (как cookie и как header, либо внутри POST данных формы);
* сервер обязан проверить на идентичность токен из cookie и токен, который явно прислал клиент (если оба токена совпадают, то запрос не подвергся CSRF-Атаке, в ином случае — логируем событие и отклоняем запрос).

3) SameSite Cookies (Chrome, Opera)
* cookie не нужно передавать, если запрос идет с сайта, отличного от того, на котором cookie была установлена (защита ресурса от CSRF без использования дополнительных инструментов);
* Chrome уже сейчас поддерживает эту возможность.

4) Content-Type based protection
* gользователь должен отправить запрос с определенным заголовком Content-Type, например, application/json; 
(в браузере через HTML форму или XHR API невозможно отправить произвольный Content-Type cross-origin, поэтому классическая CSRF-атака не работает).

5) Referer-based protection
* пользователь должен отправить запрос с определенным значением заголовка Referer; 
* бэкенд его проверяет, если он неверный, то считается, что это CSRF-атака;
(в браузере нельзя отправить произвольный Referer через HTML форму или XHR API, поэтому классическая CSRF-атака не работает).

6) Password confirmation / websudo
* пользователь должен подтверждать действие с помощью пароля (или секрета);
(атакующий его не знает, поэтому классическая CSRF-атака не работает).


## Дополнительно
Здесь приложить дополнительную информацию и источники, которые использовали, но не указали выше в других местах.

## Обход защиты
Если существуют варианты обхода защиты, то можно их здесь перечислить.

Если есть возможность, то надо написать в чем заключается защита и каким образом она обходится.
