# SSRF - Server Side Request Forgery

## Описание

SSRF - уязвимость, позволяющая злоумышленнику спровоцировать сервер на отправку произвольных запросов от своего имени. Данная уязвимость появляется при возможности редактировании пользователем URL-адреса, при этом сервер делает запрос во внутреннюю сеть.

## Условия

- ОС: любая
- язык: любой
- компоненты: любые
- настройки: наличие в коде особого функционала

## Детектирование

Способ 1: поиск URL в пользовательском вводе.
С помощью Burp Suit смотрим запрос. Можно увидеть, что парсится вся страница яндекса.
![Image alt](https://github.com/lifeskipp/shift2019/raw/master/ssrf/images/1_pars.png)

Из этого можно сделать вывод, что мы можем подставить туда произвольный запрос, например, обратиться к локал хосту. 

Способ 2: Burp Suite Collaborator

С помощью сервера колаборатора можно убедится в том, что запросы проходят по удалённому веб-серверу.
Нужно скопировать payload, который был сгенерирован коллаборатором, нажав: Copy to Clipboard

![Image alt](https://github.com/lifeskipp/shift2019/raw/master/ssrf/images/2_2_copy.jpg)

Затем payload нужно вставить в уязвимый параметр (в нашем случае url). 

![Image alt](https://github.com/lifeskipp/shift2019/raw/master/ssrf/images/2_3_paste.jpg)

Уязвимый сервер отравил запросы DNS и HTTP

![Image alt](https://github.com/lifeskipp/shift2019/raw/master/ssrf/images/2_collab.png)

Это подтверждает наличие уязвимости.

## Эксплуатация

Существует несколько протоколов, которые можно эксплуатировать для SSRF:
- HTTP/HTTPS - внедрение произвольных GET запросов;
- GOPHER - произвольные TCP пакеты;
- TFDP - произвольные UDP диаграммы;
- File - обращение к диску.	

### HTTP/HTTPS
 
- Обращение к локалхосту
```
http://127.0.0.1/
http://0.0.0.0/
http://localhost/
```
Обращение делаем с помощью Burp Suite
![Image alt](https://github.com/lifeskipp/shift2019/raw/master/ssrf/images/3_localhost.png)

- Получаем доступ к админке

Так как у нас есть исходный код, мы можем заметить в нём интересные детали, а именно:
```python
@app.route("/secret")
def secret():

	ip = request.remote_addr

	if ip == '127.0.0.1':

		is_secret_view = False

		if request.args.get('show_me_secrets') == 'true':
			is_secret_view = True

		return render_template('secret.html', ip=ip, is_secret_view=is_secret_view)

	else:
		return 'Forbidden', 403
```
Здесь видно, что мы довольно легко можем получить доступ к админке, изменив url на: http://127.0.0.1/secret?show_me_secrets=true
![Image alt](https://github.com/lifeskipp/shift2019/raw/master/ssrf/images/4_admin.png)

- Облачные API

Если у сервера есть доступ к облачному API, то можно спровоцировать его на отправку произвольных реквестов, а так же осуществить RCE.

- Скан сети

Формируя запросы на разные порты и IP-адреса внутренней сети, можно понять инфраструктуру этой сети.

Использование протоколы HTTP/HTTPS для эксплуатации SSRF мы получаем наибольший профит. Можно использовать и другие протоколы, например: TCP, UDP и т.д., но большого импакта они не несут, так как имеют очень много ограничений.

### File

Библеотека cURL позволяет работать с другими протоколами (не только с HTTP/HTTPS). Благодаря этому можно обратится к диску и вытащить файлы. Например, с помощью замены URL на: file:///app/main.py

![Image alt](https://github.com/lifeskipp/shift2019/raw/master/ssrf/images/5_file.jpg)

### Инструменты

- Burp Suite  - с его помощью можем менять URL, который отправляет сервер, тем самым попадаем в локалхост.

## Ущерб

Злоумышленник может отправлять запросы во внутреннюю сеть или подсеть, просканировать порты и саму сеть.
Так же злоумышленник с помощью SSRF может выполнять произвольные HTTP GET-запросы.
Можно получить доступ к различным закрытым путям или облачным API.

## Защита
### Основные меры

- Проверять схему в ссылке и работать только с HTTP/HTTPS
- Проверять адрес в ссылке и блокировать запросы на внутренние подсети
(192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8, 127.0.0.0/8 и т.д.)
НО от данной атаки на 100% защититься нельзя.

### Превентивные меры
Вынести сервер, обрабатыващий URL в отдельный сегмент сети


## Дополнительно
Здесь приложить дополнительную информацию и источники, которые использовали, но не указали выше в других местах.

## Обход защиты
- Сокращения
```
http://127.1/
http://0/
```
- Представление не в десятичной форме
```
http://0177.1/
http://0x7f.1/
http://2130706433/
```
