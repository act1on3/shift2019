# SSTI
  
  
  ## Описание
  в современных веб-приложениях часто используются шаблонизаторы. То есть шаблонизаторы (в вебе) используются для того, чтобы отделить 
  HTML код(представление данных) от кода языка. Что же такое шаблон? Шаблон – это файл, содержащий HTML и некоторые маркеры, позволяющий
  этот шаблон обработать и сформировать на его основе конечный HTML код.
  Из-за чего возникают уязвимость SSTI? Конечно же, из-за неверной обработки пользовательских данных.
  
  ## Классификация
  Классифицируются по шаблонизаторам: Smarty, Mako, Twig, and Jinja2.
  
  ## Условия
  - ОС: -
  - язык: -
  - компоненты: шаблонизатор
  - настройки: -
  
  ## Детектирование
  Обнаружение 2 способами:  
  - Первый способ: пользовательский ввод помещается в шаблонное выражение.  
  - Второй способ: пользовательский ввод может быть помещён внутри шаблонного выражения, как правило, в качестве имени переменной.
  Идентификация:  
  Выяснить, какой шаблонизатор используется. Сделать это очень просто, так как есть готовая схема для этой цели. Этот процесс выглядит так:  
  ![](https://defcon.ru/wp-content/uploads/2016/11/1.png)  
  Нам всего-то нужно подставлять конкретные выражения и следить за ответом сервера. В некоторых случаях одно выражаение может приводить к разным ответам сервера (в зависимости от того, какой шаблонизатор используется). Например, {{7*’7′}} вернёт 49, если используется Twig, 7777777, если используется Jinja2 и не вернёт ничего, если шаблонизатор не используется.
  
  #### 1 шаг
  ![1](https://pp.userapi.com/c846121/v846121517/18bd00/2Po0PiSSPa8.jpg)  
  #### 2 шаг 
  ![2](https://pp.userapi.com/c846121/v846121517/18bd07/pR0f_0JxmBs.jpg)  
  #### 3 шаг
  ![3](https://pp.userapi.com/c846121/v846121517/18bd0e/KZD9VkHvts8.jpg)  
  #### Конечный вывод: 7777777. Мы имеем дело с Jinja2.
  
  
  ## Эксплуатация
  После того, как мы выяснили какой шаблонизатор используется, следующий наш шаг — чтение документации. Вот ключевые области на которые стоит обратить внимание:
  раздел «For Template Authors» описывает базовый синтаксис;
  «Security Considerations» — есть огромный шанс, что разработчики не читали данный раздел;
  список встроеных функций, методов, переменных;
  список дополнений/расширений — некоторый из них могут быть включены по умолчанию.
  В том случае, если в документации не будет говориться о встроенных переменных, то нам придётся их брутить. Нужные словари находятся в Burp Intruder и FuzzDB.
  ### Ручная эксплуатация
  Попробуем вызвать основные шаблоны. 
  
  ![self](https://pp.userapi.com/c846121/v846121517/18bcf9/B2iSScgkCMQ.jpg)  
  Посмотрим конфигурацию сервера:  
  
  ![config](https://pp.userapi.com/c849132/v849132517/112edb/szvDnHpBZw4.jpg)
  Узнаем скрытый в программном коде секрет:   
  
  ![secret](https://pp.userapi.com/c849132/v849132517/112eed/sPWNeku-cVI.jpg)
  #### Исполнение любых команд на сервере (с правами суперпользователя)
  Проверим выполнение последосвательности команд `id`;`ls`;`echo "im knockie, im winner!" >> hacked.txt`; `cat hacked.txt`, закодировав их в base64 и urlencode.
  ![cmd2](https://pp.userapi.com/c849132/v849132517/112f04/TbdIfSu1PAg.jpg)
  Результат запроса:
  ![cmd](https://pp.userapi.com/c849132/v849132517/112efd/tuUyVE4ZbU0.jpg)
  Однако, данные действия возможно автоматизировать, используя консольную утилиту `tplmap`:
  ![tpl](https://pp.userapi.com/c849132/v849132517/112f27/l7Ak41yusFs.jpg)
  С помощью данной утилиты также возможно захватить управление в реальном времени: 
  ![tpl2](https://pp.userapi.com/c849132/v849132517/112f47/7Pm6007VLf8.jpg)
  ### Инструменты
  [Tplmap.](https://github.com/epinna/tplmap)
  
  ## Ущерб
  Исполнение любых команд системы с правами суперпользователя. Полная утечка информации о системе и конфигурации, возможность полного уничтожения или заражения данных.
  
  ## Защита(?)
  ### Основные меры
  Имя может состоять только из букв латинского алфавита. Изменяем исходный код таким образом, чтобы игнорировать ненужные символы.  
  Исходный код:
  ![code](https://pp.userapi.com/c849132/v849132289/1166bd/K_7su5Rg3Kk.jpg)  
  
  Проверка работоспособности:  
  
  ![fil](https://pp.userapi.com/c849132/v849132289/1166a4/T8wirzD24kA.jpg)  
  
  Проверка работоспособности через tplmap:  
  
  ![tplm](https://pp.userapi.com/c849132/v849132289/1166c6/oNOZ7f7LDN8.jpg)  
  
  ### Превентивные меры(?)
  Фильтрация пользовательского ввода.
  
  
  ## Обход защиты(?)
  Если существуют варианты обхода защиты, то можно их здесь перечислить.
  
  Если есть возможность, то надо написать в чем заключается защита и каким образом она обходится.
  
